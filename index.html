<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹ ë¹„í•œ ìˆ˜í•™ì˜ ì„¬, êµ¬êµ¬ëœë“œ!</title>
  <style>
    @font-face {
      font-family: 'OngleipKonkon';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2412-1@1.0/Ownglyph_corncorn-Rg.woff2') format('woff2');
      font-weight: normal;
      font-display: swap;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'OngleipKonkon','Batang','Gungsuh',sans-serif;background:#fdfcf5;height:100vh;display:flex;justify-content:center;align-items:center;padding:10px;overflow:hidden; user-select: none;}
    
    .container{background:rgba(255,255,255,.9);border-radius:20px;padding:20px;max-width:900px;width:100%;position:relative;border:8px solid #8d6e63;outline:2px solid #5d4037;box-shadow:0 15px 40px rgba(0,0,0,.15);max-height:calc(100vh - 20px);display:flex;flex-direction:column;}
    
    /* ìƒë‹¨ ë²„íŠ¼ */
    .setup-header-buttons {
        position: absolute; top: 15px; left: 20px; right: 20px;
        display: flex; justify-content: space-between; z-index: 20; pointer-events: none;
    }
    .header-btn {
        background: #8d6e63; color: #fff; border: none; padding: 8px 15px;
        border-radius: 10px; font-size: 1em; cursor: pointer; border-bottom: 2px solid #5d4037;
        transition: .25s; pointer-events: auto; font-family: 'OngleipKonkon';
    }
    .header-btn:hover{background:#5d4037}

    /* ì œëª© ìŠ¤íƒ€ì¼ */
    h1{color:#c62828;margin:10px 0;text-align:center;font-size:1.8em;font-weight:normal;display:flex;gap:10px;justify-content:center;align-items:center}
    h1 .title-icon { height: 1.2em; vertical-align: middle; }

    .setup-screen,.game-screen,.result-screen{display:none; width:100%; height:100%;}
    .setup-screen.active,.game-screen.active,.result-screen.active{display:flex; flex-direction:column; align-items:center;}

    /* ì„¤ì • í™”ë©´ */
    .player-inputs{display:grid;grid-template-columns:1fr 1fr;gap:15px;width:100%;margin:20px 0;}
    .player-input{background:#fdfcf5;border:2px solid #bcaaa4;border-radius:10px;padding:15px;display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto auto;gap:5px 10px}
    .player-input label{grid-column:1/-1;font-weight:bold;color:#3e2723}
    .player-input input[type=text]{grid-row:2;grid-column:1;width:100%;padding:10px;border:2px solid #bcaaa4;border-radius:8px;font-size:1em;}
    .char-select-btn{grid-row:2;grid-column:2;padding:8px 12px;background:#8d6e63;color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .selected-char-name{grid-row:3;grid-column:1/-1;font-size:.8em;color:#c62828;height:1.2em;margin-top:5px}
    
    .btn{background:#c62828;color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:1.5em;cursor:pointer;border-bottom:4px solid #871c1c;transition:0.2s; margin-top:10px;}
    .btn:active{transform:translateY(2px);border-bottom-width:2px;}
    .btn-home {background:#5d4037; border-bottom-color:#3e2723;} 

    /* â˜… ì‹œì‘ í™”ë©´ ê¾¸ë¯¸ê¸° (ì‰¬ëŠ” ìºë¦­í„° ìœ„ì¹˜ ìˆ˜ì •) â˜… */
    .setup-deco-container {
        display: flex; 
        justify-content: space-between; 
        width: 100%; 
        margin-top: 10px; 
        padding: 0 50px; /* ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ì¢Œìš° ì—¬ë°± */
        pointer-events: none;
        position: absolute; /* ìœ„ì¹˜ ê³ ì • */
        bottom: 10px; /* í•˜ë‹¨ ë°°ì¹˜ */
        left: 0;
    }
    .setup-deco-img {
        width:auto; height:110px; object-fit: contain; opacity: 0.95;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        transition: transform 0.3s;
    }
    .setup-deco-img:hover { transform: scale(1.1) rotate(5deg); }

    /* ê²Œì„ í™”ë©´ */
    .game-screen{position:relative; justify-content:center;}
    
    .player-box{
        position:absolute; background:#fdfcf5; padding:10px; border-radius:15px;
        border:3px solid #bcaaa4; width:170px; min-height:160px; 
        display:flex; flex-direction:column; justify-content:space-between;
        z-index:5; box-shadow:0 4px 10px rgba(0,0,0,.1); transition:0.3s;
    }
    .player-box.active{border-color:#c62828;background:#fff;transform:scale(1.1); z-index:10; box-shadow:0 0 15px rgba(198, 40, 40, 0.4);}
    .player-box.timeout{opacity:.5;filter:grayscale(1);}
    
    .player-box .info-row { display:flex; justify-content:space-between; align-items:flex-start; z-index: 2; position: relative;}
    .player-box .name{font-size:1.1em;font-weight:bold;color:#3e2723;}
    .player-box .stats{font-size:0.85em;color:#5d4037; text-align: right;}
    
    .char-img {
        width: 100px; height: 100px; object-fit: contain;
        align-self: center; margin-top: -10px; margin-bottom: 5px;
        transition: transform 0.2s;
    }

    #player-box-1{top:0;left:0;}
    #player-box-2{bottom:0;left:0;}
    #player-box-3{bottom:0;right:0;}
    #player-box-4{top:0;right:0;}
    #player-box-3 .char-img, #player-box-4 .char-img { transform: scaleX(-1); }

    .problem-area{background:#fff;padding:20px;border-radius:20px;border:3px solid #8d6e63;text-align:center;width:400px;z-index:2; display:flex; flex-direction:column; align-items:center; box-shadow: 0 10px 20px rgba(0,0,0,0.1);}
    .problem{font-size:60px;font-weight:bold;color:#3e2723;margin:10px 0;font-family:'Batang', serif;}
    
    #answerInput input{
        width: 150px; height: 60px; font-size: 40px; text-align: center;
        border: 3px solid #c62828; border-radius: 15px; background: #fff8e1;
        outline: none; color: #333;
    }
    
    .feedback{font-size:1.3em;height:35px;margin:5px 0;font-weight:bold; display:flex; gap:10px; justify-content:center; align-items:center;}
    .feedback.correct{color:#2e7d32;}
    .feedback.wrong{color:#c62828;}
    
    .bonus-badge {
        font-size: 0.7em; padding: 2px 6px; border-radius: 8px; color:white;
        display:inline-block; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin-left:3px;
    }
    .bg-speed { background: #ff9800; }
    .bg-combo { background: #9c27b0; }
    .bg-char { background: #e91e63; }

    @keyframes pop { 0%{transform:scale(0);} 100%{transform:scale(1);} }

    .numpad {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        margin-top: 15px; width: 100%; max-width: 280px;
    }
    .num-btn {
        background: #f5f5f5; border: 2px solid #bcaaa4; border-radius: 10px;
        font-size: 24px; padding: 10px 0; cursor: pointer; color: #5d4037;
        font-family: 'OngleipKonkon'; transition: 0.1s;
    }
    .num-btn:active { background: #d7ccc8; transform: scale(0.95); }
    .num-btn.submit { background: #c62828; color: white; border-color: #a52727; }
    .num-btn.clear { background: #ffcc80; border-color: #ffa726; }

    /* ì—°í•„ ì• ë‹ˆë©”ì´ì…˜ */
    #turn-indicator {
        position: absolute; width: 60px; height: 60px; top: 50%; left: 50%;
        transform: translate(-50%, -50%); z-index: 20;
        transition: top 0.5s ease, left 0.5s ease; pointer-events: none;
    }
    .pencil-container { width: 100%; height: 100%; transition: transform 0.5s ease; }
    .pencil-img { width: 100%; filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.3)); }
    @keyframes wiggle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
    #turn-indicator.active .pencil-img { animation: wiggle 0.5s ease-in-out infinite; }

    /* ëª¨ë‹¬ ê³µí†µ */
    .modal-overlay{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);z-index:1000;}
    .modal-content{background:#fdfcf5;padding:20px;border-radius:15px;max-width:650px;width:95%;border:5px solid #8d6e63;text-align:center;position:relative; max-height:85vh; overflow-y:auto;}
    .modal-close-btn { position:absolute; top:10px; right:15px; font-size:1.5em; cursor:pointer; color:#8d6e63; z-index:30;}
    
    /* ìºë¦­í„° ì„ íƒ ê·¸ë¦¬ë“œ */
    .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .char-item { 
        border: 2px solid #bcaaa4; border-radius: 10px; padding: 5px; cursor: pointer; 
        background: #fff; transition: 0.2s; display:flex; flex-direction:column; align-items:center;
    }
    .char-item:hover { border-color: #c62828; transform: scale(1.05); background:#fff8e1; }
    .char-item img { width: 80px; height: 80px; object-fit: contain; }
    .char-item span { font-weight: bold; color: #5d4037; font-size: 0.9em; margin-top: 5px; }

    /* ìºë¦­í„° ìƒì„¸ ë³´ê¸° í™”ë©´ */
    .char-detail-view { display: none; flex-direction: column; align-items: center; margin-top: 10px; }
    .char-detail-content { display: flex; gap: 20px; width: 100%; text-align: left; align-items: flex-start; margin-bottom: 20px; }
    .char-detail-left { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .char-detail-img-lg { width: 180px; height: 180px; object-fit: contain; border-radius: 15px; border: 3px solid #bcaaa4; background: #fff; margin-bottom: 10px;}
    .char-detail-name { font-size: 1.8em; font-weight: bold; color: #c62828; margin-bottom: 5px; }
    .char-detail-right { flex: 1.5; background: #fff; padding: 15px; border-radius: 10px; border: 2px solid #bcaaa4; font-size: 1em; line-height: 1.6; color: #3e2723; max-height: 250px; overflow-y: auto; }
    .char-detail-buttons { display: flex; gap: 10px; justify-content: center; width: 100%; }
    .btn-back { background: #7f8c8d; border-bottom-color: #546e7a; }
    .btn-select { background: #2e7d32; border-bottom-color: #1b5e20; }

    @media (max-width: 600px) {
        .char-detail-content { flex-direction: column; align-items: center; }
        .char-detail-right { width: 100%; }
        .char-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ì†œì”¨ ìë‘ í…Œì´ë¸” */
    .hof-table { width:100%; border-collapse:collapse; margin-top:10px; }
    .hof-table th { border-bottom:2px solid #8d6e63; padding:8px; color:#c62828; position:sticky; top:0; background:#fdfcf5;}
    .hof-table td { border-bottom:1px solid #ddd; padding:8px; }
    .hof-rank { font-weight:bold; color:#5d4037; }
    
    /* â˜… ì†œì”¨ ìë‘ ëª¨ë‹¬ í•˜ë‹¨ ì—¬ë°± í™•ë³´ (ê¸€ì”¨ ê°€ë¦¼ ë°©ì§€) â˜… */
    #hofModal .modal-content { padding-bottom: 80px; }

    /* â˜… ì†œì”¨ ìë‘ êµ¬ì„ ìºë¦­í„° í¬ê¸° 60pxë¡œ ì¶•ì†Œ â˜… */
    .rest-img-deco {
        position: absolute; 
        bottom: 5px; 
        right: 5px; 
        width: 60px; /* í¬ê¸° ìˆ˜ì •ë¨ */
        opacity: 1; 
        pointer-events: none;
        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
    }
  </style>
</head>
<body>

<div class="container">
    <div class="setup-header-buttons">
      <button class="header-btn" onclick="openHelpModal()">ê²Œì„ ì„¤ëª…</button>
      <button class="header-btn" onclick="openHofModal()">âœ¨ ë°˜ì§ë°˜ì§ ì†œì”¨ ìë‘</button>
    </div>

    <!-- íƒ€ì´í‹€ -->
    <h1>
        <img src="https://i.imgur.com/GlDUsUr.png" class="title-icon" alt="ì•„ì´ì½˜" style="margin-right:10px;">
        ì‹ ë¹„í•œ ìˆ˜í•™ì˜ ì„¬, êµ¬êµ¬ëœë“œ!
        <img src="https://i.imgur.com/GlDUsUr.png" class="title-icon" alt="ì•„ì´ì½˜" style="margin-left:10px; transform:scaleX(-1);">
    </h1>

    <!-- 1. ì„¤ì • í™”ë©´ -->
    <div class="setup-screen active">
      <div class="player-inputs">
        <div class="player-input">
          <label>1P (ì™¼ìª½ ìœ„)</label>
          <input type="text" id="player1" placeholder="ì´ë¦„" />
          <button class="char-select-btn" onclick="openCharModal(1)">íŒŒíŠ¸ë„ˆ ì„ íƒ</button>
          <div class="selected-char-name" id="player1-char-name"></div>
          <input type="hidden" id="player1-char" value="2ë‹¨" /> 
        </div>
        <div class="player-input">
          <label>4P (ì˜¤ë¥¸ìª½ ìœ„)</label>
          <input type="text" id="player4" placeholder="ì´ë¦„" />
          <button class="char-select-btn" onclick="openCharModal(4)">íŒŒíŠ¸ë„ˆ ì„ íƒ</button>
          <div class="selected-char-name" id="player4-char-name"></div>
          <input type="hidden" id="player4-char" value="5ë‹¨" />
        </div>
        <div class="player-input">
          <label>2P (ì™¼ìª½ ì•„ë˜)</label>
          <input type="text" id="player2" placeholder="ì´ë¦„" />
          <button class="char-select-btn" onclick="openCharModal(2)">íŒŒíŠ¸ë„ˆ ì„ íƒ</button>
          <div class="selected-char-name" id="player2-char-name"></div>
          <input type="hidden" id="player2-char" value="3ë‹¨" />
        </div>
        <div class="player-input">
          <label>3P (ì˜¤ë¥¸ìª½ ì•„ë˜)</label>
          <input type="text" id="player3" placeholder="ì´ë¦„" />
          <button class="char-select-btn" onclick="openCharModal(3)">íŒŒíŠ¸ë„ˆ ì„ íƒ</button>
          <div class="selected-char-name" id="player3-char-name"></div>
          <input type="hidden" id="player3-char" value="4ë‹¨" />
        </div>
      </div>
      <div id="setupError" style="color:red;display:none;margin-bottom:10px;font-weight:bold;"></div>
      
      <!-- ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì¢‹ì§€ë§Œ, í˜„ì¬ êµ¬ì¡°ìƒ ë°”ë¡œ ë²„íŠ¼ -->
      <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘!</button>

      <!-- â˜… ì‹œì‘ í™”ë©´ ê¾¸ë¯¸ê¸° (ëœë¤ ìºë¦­í„° ê³µê°„) â˜… -->
      <div class="setup-deco-container" id="setupDeco">
          <!-- JSë¡œ ëœë¤ ì´ë¯¸ì§€ ì‚½ì…ë¨ -->
      </div>
    </div>

    <!-- 2. ê²Œì„ í™”ë©´ -->
    <div class="game-screen">
      <div id="player-box-1" class="player-box" style="display:none"></div>
      <div id="player-box-2" class="player-box" style="display:none"></div>
      <div id="player-box-3" class="player-box" style="display:none"></div>
      <div id="player-box-4" class="player-box" style="display:none"></div>

      <div id="turn-indicator">
          <div class="pencil-container">
            <img src="https://i.imgur.com/hoFn8n7.png" class="pencil-img" alt="ì—°í•„">
          </div>
      </div>

      <div class="problem-area">
        <div class="problem" id="problemDisplay">2 Ã— 2 = ?</div>
        <div class="feedback" id="feedback"></div>
        <div id="answerInput">
             <input type="number" id="answerNum" placeholder="?" readonly />
        </div>
        <div class="numpad">
            <button class="num-btn" onclick="pressKey(7)">7</button>
            <button class="num-btn" onclick="pressKey(8)">8</button>
            <button class="num-btn" onclick="pressKey(9)">9</button>
            <button class="num-btn" onclick="pressKey(4)">4</button>
            <button class="num-btn" onclick="pressKey(5)">5</button>
            <button class="num-btn" onclick="pressKey(6)">6</button>
            <button class="num-btn" onclick="pressKey(1)">1</button>
            <button class="num-btn" onclick="pressKey(2)">2</button>
            <button class="num-btn" onclick="pressKey(3)">3</button>
            <button class="num-btn clear" onclick="pressKey('C')">ì§€ì›€</button>
            <button class="num-btn" onclick="pressKey(0)">0</button>
            <button class="num-btn submit" onclick="checkAnswer()">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- 3. ê²°ê³¼ í™”ë©´ -->
    <div class="result-screen">
        <h2 style="color:#c62828; font-size:2em; margin-bottom:20px;">ğŸŠ ê²Œì„ ì¢…ë£Œ! ğŸŠ</h2>
        <div id="final-chart" style="width:100%; height:320px; display:flex; justify-content:center; align-items:flex-end; gap:20px;"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-home" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
            <button class="btn" onclick="restartGame()">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ìºë¦­í„° ì„ íƒ ëª¨ë‹¬ -->
<div id="characterModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn" onclick="closeCharModal()">&times;</span>
        <h2 id="charModalTitle">íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
        <div id="charGrid" class="char-grid"></div>
        <div id="charDetailView" class="char-detail-view">
            <div class="char-detail-content">
                <div class="char-detail-left">
                    <img id="detailImg" src="" class="char-detail-img-lg" />
                    <div id="detailName" class="char-detail-name"></div>
                </div>
                <div id="detailDesc" class="char-detail-right"></div>
            </div>
            <div class="char-detail-buttons">
                <button class="btn btn-back" onclick="showGrid()">ë’¤ë¡œ</button>
                <button class="btn btn-select" onclick="confirmSelection()">ì´ íŒŒíŠ¸ë„ˆ ê²°ì •!</button>
            </div>
        </div>
    </div>
</div>

<!-- ë„ì›€ë§ ëª¨ë‹¬ -->
<div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn" onclick="closeHelpModal()">&times;</span>
        <h2>ê²Œì„ ì„¤ëª…</h2>
        <ul style="text-align:left; padding-left:20px; line-height:1.6;">
            <li>ìê¸° í„´ì´ ì˜¤ë©´ êµ¬êµ¬ë‹¨ ë¬¸ì œë¥¼ í‘¸ì„¸ìš”.</li>
            <li>ì œí•œ ì‹œê°„ì€ <b>2ë¶„ (120ì´ˆ)</b> ì…ë‹ˆë‹¤.</li>
            <li>ì •ë‹µì´ë©´ ê¸°ë³¸ <b>+10ì </b>!</li>
            <li><b>5ì´ˆ ì•ˆì—</b> í’€ë©´ <b>+5ì </b> (ì†ë„ ë³´ë„ˆìŠ¤)</li>
            <li><b>3ì—°ì† ì •ë‹µ</b>ë¶€í„°ëŠ” <b>+5ì </b> (ì •í™•ë„ ë³´ë„ˆìŠ¤)</li>
            <li><b>ë‚´ ìºë¦­í„°ì™€ ê°™ì€ ë‹¨</b> ë¬¸ì œë¥¼ ë§íˆë©´ <b>+1ì </b> (íŒŒíŠ¸ë„ˆ ë³´ë„ˆìŠ¤)</li>
            <li>ì ìˆ˜ê°€ ê°€ì¥ ë†’ì€ ì¹œêµ¬ê°€ <b>ì†œì”¨ ì™•</b>ì´ ë©ë‹ˆë‹¤!</li>
        </ul>
    </div>
</div>

<!-- âœ¨ ë°˜ì§ë°˜ì§ ì†œì”¨ ìë‘ ëª¨ë‹¬ -->
<div id="hofModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn" onclick="closeHofModal()">&times;</span>
        <h2>âœ¨ ë°˜ì§ë°˜ì§ ì†œì”¨ ìë‘ (TOP 10)</h2>
        <table class="hof-table">
            <thead>
                <tr>
                    <th width="15%">ìˆœìœ„</th>
                    <th width="35%">ì´ë¦„</th>
                    <th width="25%">ì ìˆ˜</th>
                    <th width="25%">íŒŒíŠ¸ë„ˆ</th>
                </tr>
            </thead>
            <tbody id="hofList"></tbody>
        </table>
        <div id="hofRestImgContainer"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzN_aewFQ2nntc08_3DWVabOidlfYJ-O0CHKmF62vipYYKJqCNgXcBMI031dVl33gjt/exec";

    // === ìºë¦­í„° ë°ì´í„° ===
    const charData = {
        '2ë‹¨': {
            name: 'ë‘ë¦¬',
            desc: "ì„œìš¸ë°±ìš´ì´ˆë“±í•™êµ 2í•™ë…„ì´ì•¼! ìˆ˜í•™ í•™ì›ì— ê°€ë‹¤ê°€ ì‹ ê¸°í•œ êµ¬ë©ì— ë¹ ì¡Œì–´. ê·¸ ê³³ì€ ìˆ«ìë¥¼ ë¨¹ê³  ìë¼ëŠ” ì‹ ë¹„í•œ ìƒë¬¼ë“¤ì˜ ì„¬, êµ¬êµ¬ëœë“œì˜€ì–´! êµ¬êµ¬ë‹¨ì„ ë°°ìš´ì§€ ì–¼ë§ˆ ì•ˆë˜ì„œ 2ë‹¨ ë°–ì— í•  ì¤„ ëª°ë¼. ì‹ ë°œ, ì¥ê°‘... ì§ì´ ë§ëŠ” ê²ƒì´ ë‚˜ì—ê² ê°€ì¥ ì¤‘ìš”í•´!",
            default: 'https://i.imgur.com/GlDUsUr.png',
            correct: 'https://i.imgur.com/KK2QcQE.png',
            comboCorrect: 'https://i.imgur.com/NU045uQ.png',
            wrong: 'https://i.imgur.com/tFRjQ1Z.png',
            comboWrong: 'https://i.imgur.com/pY2AL4a.png',
            win: 'https://i.imgur.com/geuGwVB.png',
            lose: 'https://i.imgur.com/UcGdTXm.png',
            rest: 'https://i.imgur.com/B63Mb8l.png'
        },
        '3ë‹¨': {
            name: 'ì‚¼ì‚¼ì´',
            desc: "ë°˜ê°€ì›Œ! ë‚œ 'ì„¸ëª¨ ìˆ²'ì„ ì§€í‚¤ëŠ” ë§ˆë²•ì‚¬ì•¼. ë‚´ ì§€íŒ¡ì´ë¥¼ ì„¸ ë²ˆ(3) í”ë“¤ë©´ ë§›ìˆëŠ” ë„í† ë¦¬ê°€ ë¿…! í•˜ê³  ë‚˜íƒ€ë‚˜ì§€. ë‚œ ë­ë“ ì§€ ì‚¼ê°í˜•ìœ¼ë¡œ ë§Œë“œëŠ” ê±¸ ì¢‹ì•„í•´. ìƒŒë“œìœ„ì¹˜ë„ ì„¸ëª¨, ê¹€ë°¥ë„ ì„¸ëª¨ê°€ ì œì¼ ë§›ìˆê±°ë“ !",
            default: 'https://i.imgur.com/LonvsYI.png',
            correct: 'https://i.imgur.com/dbY3pe2.png',
            comboCorrect: 'https://i.imgur.com/mmZaZlC.png',
            wrong: 'https://i.imgur.com/OOtFK3M.png',
            comboWrong: 'https://i.imgur.com/GKmb1es.png',
            win: 'https://i.imgur.com/MjnJNbS.png',
            lose: 'https://i.imgur.com/gpo8CCC.png',
            rest: 'https://i.imgur.com/q0EKOQl.png'
        },
        '4ë‹¨': {
            name: 'ë„¤ëª¨ë´‡',
            desc: "ì‚-ìµ. ì‹œìŠ¤í…œ ê°€ë™. ì €ëŠ” 'ë°˜ë“¯ë°˜ë“¯ ê³µì¥'ì—ì„œ ë§Œë“¤ì–´ì§„ ë¡œë´‡, ë„¤ëª¨ë´‡ì…ë‹ˆë‹¤. ë„¤ëª¨ë‚œ ë¬¼ê±´ì„ ì°¾ìœ¼ëŸ¬ ë‹¤ë‹ˆê³  ìˆì–´ìš”. ì‚ë¦¬ì‚ë¦¬... ë„¤ëª¨ì¸ ë¬¼ê±´ì„ ê°–ê³  ê³„ì‹ ê°€ìš”? ê·¸ëŸ¼ ì €ì™€ ì¹œêµ¬ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            default: 'https://i.imgur.com/2RrOu6e.png',
            correct: 'https://i.imgur.com/XOvmE3L.png',
            comboCorrect: 'https://i.imgur.com/yeDXnhH.png',
            wrong: 'https://i.imgur.com/DLVTQ2h.png',
            comboWrong: 'https://i.imgur.com/YUy1X3G.png',
            win: 'https://i.imgur.com/Qzh7hXz.png',
            lose: 'https://i.imgur.com/DuLXmNZ.png',
            rest: 'https://i.imgur.com/ZxIBE5D.png'
        },
        '5ë‹¨': {
            name: 'ì˜¤ì§•',
            desc: "ìš°ì£¼ ì € ë©€ë¦¬ 'ë³„ ë‹¤ì„¯ ê°œ í–‰ì„±'ì—ì„œ UFOë¥¼ íƒ€ê³  ì™”ì–´! ë‚œ ì‹œê³„ ë³´ëŠ” ê±¸ ì•„ì£¼ ì¢‹ì•„í•´. 5ë¶„, 10ë¶„, 15ë¶„... ê¸´ ë°”ëŠ˜ì´ 5ì¹¸ì”© ì›€ì§ì¼ ë•Œë§ˆë‹¤ ì‹¬ì¥ì´ ë‘ê·¼ê±°ë ¤. ë‚˜ë‘ ì‹ ë‚˜ê²Œ ì†ë°”ë‹¥ì„ ë¶€ë”ªí˜€ ë³´ì!",
            default: 'https://i.imgur.com/4hKhhMU.png',
            correct: 'https://i.imgur.com/pBWilZp.png',
            comboCorrect: 'https://i.imgur.com/kDyeOIC.png',
            wrong: 'https://i.imgur.com/kRKDvi1.png',
            comboWrong: 'https://i.imgur.com/PnLT0F0.png',
            win: 'https://i.imgur.com/IIHjQDU.png',
            lose: 'https://i.imgur.com/gdYvI2H.png',
            rest: 'https://i.imgur.com/AzleGIa.png'
        },
        '6ë‹¨': {
            name: 'ë‹¨ì´',
            desc: "ë‹¬ì½¤í•œ ëƒ„ìƒˆê°€ ë‚˜ì§€ ì•Šë‹ˆ? ë‚œ 'ì„¤íƒ• ê³¼ì ì–¸ë•'ì— ì‚¬ëŠ” íŒŒí‹°ì…°ì•¼. ë‚´ ë¨¸ë¦¬ ìœ„ì˜ 6ëª¨ì–‘ ì´›ë¶ˆì€ ê¸°ë¶„ì´ ì¢‹ìœ¼ë©´ í™œí™œ íƒ€ì˜¬ë¼! í”¼ìë„, ì¼€ì´í¬ë„, ì‚¬ê³¼ë„ ë”± 6ì¡°ê°ìœ¼ë¡œ ë˜‘ê°™ì´ ë‚˜ëˆ„ëŠ” ê²Œ ë‚˜ì˜ íŠ¹ê¸°ì§€. ë‚˜ì™€ ê°™ì´ ë‹¬ì½¤í•œ êµ¬êµ¬ë‹¨ íŒŒí‹°ë¥¼ í•´ë³´ì§€ ì•Šì„ë˜?",
            default: 'https://i.imgur.com/0ATkbkG.png',
            correct: 'https://i.imgur.com/dDcLLth.png',
            comboCorrect: 'https://i.imgur.com/RkUCs9Y.png',
            wrong: 'https://i.imgur.com/vlBhrIY.png',
            comboWrong: 'https://i.imgur.com/iNmWiqS.png',
            win: 'https://i.imgur.com/IlLmMwP.png',
            lose: 'https://i.imgur.com/cPoVG4P.png',
            rest: 'https://i.imgur.com/ArSK2Gl.png'
        },
        '7ë‹¨': {
            name: 'ì¹ ë¡±ì´',
            desc: "ì•ˆë…•~ ë‚œ 'ë¬´ì§€ê°œ êµ¬ë¦„ ìœ„'ì— ì‚¬ëŠ” ê¸°ë¦°ì´ë€ë‹¤. ë‚´ ëª©ì€ í–‰ìš´ì˜ ìˆ«ì 7ì„ ë‹®ì•„ì„œ íœ˜ì–´ìˆì–´. ë•ë¶„ì— ë†’ì€ ê³³ì— ìˆëŠ” ì¼ê³± ë¹›ê¹” ìì‚¬ê·€ë¥¼ ë”° ë¨¹ì„ ìˆ˜ ìˆì§€. 7ë‹¨ì´ ì–´ë µë‹¤ê³ ? ê±±ì • ë§ˆ. ë‚´ ê¸´ ëª©ì„ ì­‰ ë»—ì–´ì„œ ì € ë©€ë¦¬ ìˆ¨ê²¨ì§„ ì •ë‹µì„ ì°¾ì•„ì¤„ê²Œ!",
            default: 'https://i.imgur.com/KqRY8Ms.png',
            correct: 'https://i.imgur.com/qpZPBCI.png',
            comboCorrect: 'https://i.imgur.com/YmsFXk8.png',
            wrong: 'https://i.imgur.com/t9GdsDr.png',
            comboWrong: 'https://i.imgur.com/ldOioE6.png',
            win: 'https://i.imgur.com/qSvz3hT.png',
            lose: 'https://i.imgur.com/DAvxj9X.png',
            rest: 'https://i.imgur.com/V4jb4p2.png'
        },
        '8ë‹¨': {
            name: 'í¼ì‹œ ì„ ìƒë‹˜',
            desc: "'ê¹Šì€ ë°”ë‹¤ êµì‹¤'ì˜ ì£¼ì¸, í¼ì‹œ ì„ ìƒë‹˜ì´ë‹¤. ë‚´ 8ê°œì˜ ë‹¤ë¦¬ê°€ ë³´ì´ëŠëƒ? ì´ ë‹¤ë¦¬ë“¤ë¡œ ì¹ íŒë„ ë‹¦ê³ , ì±„ì ë„ í•˜ê³ , ì¡°ëŠ” ì•„ì´ë“¤ì„ ê¹¨ìš°ê¸°ë„ í•˜ì§€. 8ë‹¨ì€ ìˆ«ìê°€ ì‘¥ì‘¥ ì»¤ì ¸ì„œ ê²ë¨¹ëŠ” ì¹œêµ¬ë“¤ì´ ë§ë”êµ¬ë‚˜. í•˜ì§€ë§Œ ëì—†ì´ ëŠ˜ì–´ë‚˜ëŠ” ë‚´ ë‹¤ë¦¬ ì²˜ëŸ¼ ëˆê¸°ë¥¼ ê°€ì§„ë‹¤ë©´ ë„ˆë„ ìˆ˜í•™ ë§ˆë²•ì‚¬ê°€ ë  ìˆ˜ ìˆì„ ê²Œë‹¤. ì, ìˆ˜ì—… ì‹œì‘ì´ë‹¤!",
            default: 'https://i.imgur.com/mrOi789.png',
            correct: 'https://i.imgur.com/hwA66B8.png',
            comboCorrect: 'https://i.imgur.com/8HqYQ2f.png',
            wrong: 'https://i.imgur.com/fNostsh.png',
            comboWrong: 'https://i.imgur.com/aSN1d5a.png',
            win: 'https://i.imgur.com/JHFT2Ye.png',
            lose: 'https://i.imgur.com/NeoyZ6e.png',
            rest: 'https://i.imgur.com/WXDEzKP.png'
        },
        '9ë‹¨': {
            name: 'êµ¬êµ¬',
            desc: "ì˜ì°¨, ì˜ì°¨... ì•ˆë…•? ë‚œ 'ë§ˆì§€ë§‰ ììƒˆ'ì— ì‚¬ëŠ” ì• ë²Œë ˆì•¼. ëª¸ì´ ì—¬ëŸ¬ ë§ˆë””ë¼ì„œ ê±·ëŠ” ê²Œ ì¢€ ëŠë ¤. êµ¬êµ¬ë‹¨ì„ ëê¹Œì§€ ë‹¤ ì™¸ìš°ë©´, ë‚´ ë“± ë’¤ì˜ ê»ì§ˆì„ ë²—ê³  ë©‹ì§„ ë‚˜ë¹„ê°€ ë  ê±°ë¼ëŠ” ì „ì„¤ì´ ìˆëŒ€. ë„ˆë„ í¬ê¸°í•˜ì§€ ë§ê³  ë‚˜ë‘ ëê¹Œì§€ í•¨ê»˜í•´ ì¤„ë˜?",
            default: 'https://i.imgur.com/A6cuv2e.png',
            correct: 'https://i.imgur.com/eJFosRk.png',
            comboCorrect: 'https://i.imgur.com/U5LlyBm.png',
            wrong: 'https://i.imgur.com/v4sxnZQ.png',
            comboWrong: 'https://i.imgur.com/mTkn9e7.png',
            win: 'https://i.imgur.com/NMR3Z1y.png',
            lose: 'https://i.imgur.com/nDETxyO.png',
            rest: 'https://i.imgur.com/ko4Fgi9.png'
        }
    };

    let players = [];
    let currentPlayerIndex = 0;
    const TOTAL_TIME = 120;
    let timerInterval;
    let currentProblem = {};
    let problemStartTime = 0;
    let currentPlayerSelecting = 1;
    let selectedCharKey = ''; 
    
    // â˜… ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ í”Œë˜ê·¸ ì¶”ê°€
    let isProcessing = false;

    // â˜… ì´ë¯¸ì§€ í”„ë¦¬ë¡œë”© í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€í•  ë¶€ë¶„) â˜…
    function preloadImages() {
        const imagesToLoad = [];
        
        // 1. ìºë¦­í„° ì´ë¯¸ì§€ ìˆ˜ì§‘
        Object.values(charData).forEach(char => {
            Object.values(char).forEach(val => {
                if(typeof val === 'string' && val.startsWith('http')) {
                    imagesToLoad.push(val);
                }
            });
        });

        // 2. ê¸°íƒ€ UI ì´ë¯¸ì§€ ìˆ˜ì§‘ (ì—°í•„, íƒ€ì´í‹€ ì•„ì´ì½˜)
        imagesToLoad.push('https://i.imgur.com/hoFn8n7.png'); 
        imagesToLoad.push('https://i.imgur.com/GlDUsUr.png'); 

        // 3. ë¸Œë¼ìš°ì €ê°€ ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œí•˜ê²Œ ë§Œë“¤ê¸°
        imagesToLoad.forEach(url => {
            const img = new Image();
            img.src = url;
        });
        console.log("ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
    }

    // === DOMContentLoaded ì‹œ ì‹œì‘ í™”ë©´ ê¾¸ë¯¸ê¸° ===
    document.addEventListener('DOMContentLoaded', () => {
        renderSetupDeco();
        preloadImages();
    });

    function renderSetupDeco() {
        const container = document.getElementById('setupDeco');
        if(!container) return;
        container.innerHTML = '';

        // ëœë¤ 2ëª… ë½‘ê¸° (ì„œë¡œ ë‹¤ë¥¸)
        let n1 = Math.floor(Math.random() * 8) + 2; // 2~9
        let n2 = Math.floor(Math.random() * 8) + 2;
        while(n1 === n2) {
            n2 = Math.floor(Math.random() * 8) + 2;
        }

        const c1 = charData[`${n1}ë‹¨`];
        const c2 = charData[`${n2}ë‹¨`];

        // ì¢Œì¸¡
        const img1 = document.createElement('img');
        img1.src = c1.rest;
        img1.className = 'setup-deco-img';
        img1.style.transform = 'scaleX(1)'; // ì™¼ìª½ ì¹œêµ¬ëŠ” ì˜¤ë¥¸ìª½ ë³´ê¸°(ê¸°ë³¸)

        // ìš°ì¸¡
        const img2 = document.createElement('img');
        img2.src = c2.rest;
        img2.className = 'setup-deco-img';
        img2.style.transform = 'scaleX(-1)'; // ì˜¤ë¥¸ìª½ ì¹œêµ¬ëŠ” ì™¼ìª½ ë³´ê¸°

        container.appendChild(img1);
        container.appendChild(img2);
    }

    function startGame() {
        players = [];
        const inputs = [1, 2, 3, 4];
        let validCount = 0;

        inputs.forEach(id => {
            const nameEl = document.getElementById(`player${id}`);
            const charEl = document.getElementById(`player${id}-char`);
            const name = nameEl.value.trim();
            const charKey = charEl.value || '2ë‹¨';

            if (name) {
                players.push({
                    id: id, name: name, character: charKey,
                    score: 0, timeLeft: TOTAL_TIME, active: true,
                    consecutiveCorrect: 0, consecutiveWrong: 0,
                    actionState: 'default'
                });
                validCount++;
            }
        });

        if (validCount < 1) {
            const err = document.getElementById('setupError');
            err.textContent = "ìµœì†Œ 1ëª…ì˜ ì¹œêµ¬ê°€ í•„ìš”í•´ìš”!";
            err.style.display = "block";
            return;
        }

        document.querySelector('.setup-screen').classList.remove('active');
        document.querySelector('.game-screen').classList.add('active');
        
        players.forEach(p => {
            const box = document.getElementById(`player-box-${p.id}`);
            box.style.display = 'flex';
            updatePlayerBox(p);
        });
        startRound();
    }

    function restartGame(){
        players.forEach(p => {
            p.score = 0; p.timeLeft = TOTAL_TIME; p.active = true;
            p.consecutiveCorrect = 0; p.consecutiveWrong = 0;
            p.actionState = 'default';
        });
        document.querySelector('.result-screen').classList.remove('active');
        document.querySelector('.game-screen').classList.add('active');
        
        players.forEach(p => {
            const box = document.getElementById(`player-box-${p.id}`);
            box.classList.remove('timeout');
            updatePlayerBox(p);
        });
        currentPlayerIndex = 0;
        startRound();
        renderSetupDeco(); // ë‹¤ì‹œ ì‹œì‘í•  ë•Œë„ ë°ì½” ê°±ì‹ 
    }

    function startRound() {
        // â˜… ìƒˆ ë¼ìš´ë“œ ì‹œì‘ ì‹œ ì¤‘ë³µ ë°©ì§€ ë½ í•´ì œ
        isProcessing = false;

        const activePlayers = players.filter(p => p.active);
        if (activePlayers.length === 0) { endGame(); return; }

        let loopCount = 0;
        while (!players[currentPlayerIndex].active) {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            loopCount++;
            if(loopCount > players.length) { endGame(); return; }
        }

        const currPlayer = players[currentPlayerIndex];
        
        updateTurnIndicator(currPlayer.id);
        document.getElementById('turn-indicator').classList.add('active');

        players.forEach(p => document.getElementById(`player-box-${p.id}`).classList.remove('active'));
        document.getElementById(`player-box-${currPlayer.id}`).classList.add('active');

        generateProblem(currPlayer);
        problemStartTime = Date.now();
        
        const inputEl = document.getElementById('answerNum');
        inputEl.value = '';
        inputEl.focus();
        document.getElementById('feedback').innerHTML = '';

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (currPlayer.timeLeft > 0) {
                currPlayer.timeLeft--;
                updatePlayerBox(currPlayer);
            } else {
                currPlayer.active = false;
                document.getElementById('feedback').textContent = "â° ì‹œê°„ ë! ì¢…ë£Œ!";
                document.getElementById(`player-box-${currPlayer.id}`).classList.add('timeout');
                document.getElementById('turn-indicator').classList.remove('active');
                clearInterval(timerInterval);
                setTimeout(nextTurn, 1500);
            }
        }, 1000);
    }

    function nextTurn() {
        const prevPlayer = players[currentPlayerIndex];
        if(prevPlayer) {
             prevPlayer.actionState = 'default';
             updatePlayerBox(prevPlayer);
        }
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        startRound();
    }

    function generateProblem(player) {
        // 1. ë‹¨(Dan) ê·¸ë£¹ ì •ì˜
        const easyDans = [2, 3, 4, 5]; // ë¹„êµì  ì‰¬ìš´ ë‹¨
        const hardDans = [6, 7, 8, 9]; // ë¹„êµì  ì–´ë ¤ìš´ ë‹¨

        // 2. 'ì–´ë ¤ìš´ ë‹¨'ì´ ë‚˜ì˜¬ ê¸°ë³¸ í™•ë¥  (0.5 = 50%)
        let hardChance = 0.5;

        // 3. ì—°ì† ì •ë‹µ ìˆ˜ì— ë”°ë¼ ì–´ë ¤ìš´ í™•ë¥  ì¦ê°€ (ê°œë‹¹ 10%ì”©, ìµœëŒ€ 90%)
        if (player.consecutiveCorrect > 0) {
            hardChance += (player.consecutiveCorrect * 0.1);
            if (hardChance > 0.9) hardChance = 0.9; // ìµœëŒ€ 90%ë¡œ ì œí•œ (10%ëŠ” ì‰¬ìš´ê±° ë‚˜ì˜´)
        }

        // 4. ì—°ì† ì˜¤ë‹µ ìˆ˜ì— ë”°ë¼ ì–´ë ¤ìš´ í™•ë¥  ê°ì†Œ (ê°œë‹¹ 15%ì”©, ìµœì†Œ 10%)
        if (player.consecutiveWrong > 0) {
            hardChance -= (player.consecutiveWrong * 0.15);
            if (hardChance < 0.1) hardChance = 0.1; // ìµœì†Œ 10%ëŠ” ìœ ì§€ (90%ëŠ” ì‰¬ìš´ê±° ë‚˜ì˜´)
        }

        // 5. í™•ë¥  ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (0 ~ 1 ì‚¬ì´ì˜ ë‚œìˆ˜)
        const luckyDice = Math.random();
        let selectedDan;

        // í”¼ë“œë°± ë¬¸êµ¬ ì´ˆê¸°í™”
        const feedbackEl = document.getElementById('feedback');
        feedbackEl.innerHTML = "";

        if (luckyDice < hardChance) {
            // [ì–´ë ¤ìš´ ë‹¨ ë‹¹ì²¨!]
            selectedDan = hardDans[Math.floor(Math.random() * hardDans.length)];
            
            // 3ì—°ì† ì´ìƒ ì •ë‹µìì—ê²Œë§Œ 'ë„ì „' ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
            if (player.consecutiveCorrect >= 3) {
                feedbackEl.innerHTML = "<span style='color:blue; font-size:0.8em;'>ğŸ”¥ ë„ì „! ì–´ë ¤ìš´ ë¬¸ì œ!</span>";
            }
        } else {
            // [ì‰¬ìš´ ë‹¨ ë‹¹ì²¨!]
            selectedDan = easyDans[Math.floor(Math.random() * easyDans.length)];

            // 3ì—°ì† ì´ìƒ ì˜¤ë‹µìì—ê²Œë§Œ 'í˜ë‚´' ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
            if (player.consecutiveWrong >= 3) {
                feedbackEl.innerHTML = "<span style='color:green; font-size:0.8em;'>ğŸ’ª í˜ë‚´! ì‰¬ìš´ ë¬¸ì œ!</span>";
            }
        }

        // 6. ê³±í•´ì§€ëŠ” ìˆ˜ (1~9) ëœë¤
        const num = Math.floor(Math.random() * 9) + 1;

        // 7. ë¬¸ì œ ì¶œì œ
        currentProblem = { dan: selectedDan, num: num, answer: selectedDan * num };
        document.getElementById('problemDisplay').textContent = `${selectedDan} Ã— ${num} = ?`;
    }

    function checkAnswer() {
        // â˜… ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ í•¨ìˆ˜ ì‹¤í–‰ì„ ë©ˆì¶¤
        if (isProcessing) return;

        const inputEl = document.getElementById('answerNum');
        const userVal = parseInt(inputEl.value);
        if (isNaN(userVal)) return; 

        // â˜… ì²˜ë¦¬ ì‹œì‘: ê¹ƒë°œ ê½‚ê¸° (ì ê¸ˆ)
        isProcessing = true;

        clearInterval(timerInterval);
        document.getElementById('turn-indicator').classList.remove('active');

        const player = players[currentPlayerIndex];
        const feedbackEl = document.getElementById('feedback');
        const timeSpent = (Date.now() - problemStartTime) / 1000;

        if (userVal === currentProblem.answer) {
            const BASE_SCORE = 10;
            const SPEED_BONUS = 5;
            const COMBO_BONUS = 5;
            const CHAR_BONUS = 1; 

            let earnedScore = BASE_SCORE;
            let bonusBadges = "";

            if (timeSpent <= 5.0) {
                earnedScore += SPEED_BONUS;
                bonusBadges += `<span class="bonus-badge bg-speed">âš¡ì†ë„ì™• (+${SPEED_BONUS})</span>`;
            }
            if (player.consecutiveCorrect >= 2) { 
                earnedScore += COMBO_BONUS;
                bonusBadges += `<span class="bonus-badge bg-combo">ğŸ”¥ì—°ì†ì •ë‹µ (+${COMBO_BONUS})</span>`;
            }
            const playerDan = parseInt(player.character); 
            if (playerDan === currentProblem.dan) {
                earnedScore += CHAR_BONUS;
                bonusBadges += `<span class="bonus-badge bg-char">âœ¨íŒŒíŠ¸ë„ˆ ë³´ë„ˆìŠ¤ (+${CHAR_BONUS})</span>`;
            }
            
            player.score += earnedScore;
            player.consecutiveCorrect++;
            player.consecutiveWrong = 0;
            player.actionState = (player.consecutiveCorrect >= 3) ? 'comboCorrect' : 'correct';

            feedbackEl.innerHTML = `<span style='color:#2e7d32'>â­• ì •ë‹µ! (+${BASE_SCORE})</span> ${bonusBadges}`;
            feedbackEl.className = "feedback correct";
        } else {
            player.consecutiveCorrect = 0;
            player.consecutiveWrong++;
            player.actionState = (player.consecutiveWrong >= 3) ? 'comboWrong' : 'wrong';
            feedbackEl.innerHTML = `âŒ ë•¡! ì •ë‹µì€ ${currentProblem.answer} ì…ë‹ˆë‹¤.`;
            feedbackEl.className = "feedback wrong";
        }
        updatePlayerBox(player);
        setTimeout(nextTurn, 1500);
    }

    function updatePlayerBox(p) {
        const box = document.getElementById(`player-box-${p.id}`);
        const min = Math.floor(p.timeLeft / 60);
        const sec = String(p.timeLeft % 60).padStart(2, '0');
        
        const charSet = charData[p.character] || charData['2ë‹¨']; 
        const imgSrc = charSet[p.actionState] || charSet['default'];

        box.innerHTML = `
            <div class="info-row">
                <div class="name">${p.name}</div>
                <div class="stats">
                    ${p.score}ì <br>
                    ${min}:${sec}<br>
                    (ì—°ì†: ${p.consecutiveCorrect})
                </div>
            </div>
            <img class="char-img" src="${imgSrc}" alt="${p.character}">
        `;
        if(!p.active) box.classList.add('timeout');
    }

    function updateTurnIndicator(playerId) {
        const ind = document.getElementById('turn-indicator');
        const container = ind.querySelector('.pencil-container');
        const positions = {
            1: { top: '20%', left: '20%' }, 2: { top: '80%', left: '20%' },
            3: { top: '80%', left: '80%' }, 4: { top: '20%', left: '80%' }
        };
        const rotations = { 1: '45deg', 2: '-45deg', 3: '-135deg', 4: '135deg' };
        if(positions[playerId]) { ind.style.top = positions[playerId].top; ind.style.left = positions[playerId].left; }
        if(rotations[playerId]) { container.style.transform = `rotate(${rotations[playerId]})`; }
    }

    function pressKey(key) {
        const el = document.getElementById('answerNum');
        if (key === 'C') el.value = '';
        else if (el.value.length < 3) el.value += key;
    }

    document.addEventListener('keydown', (e) => {
        if (!document.querySelector('.game-screen').classList.contains('active')) return;
        if (e.key >= '0' && e.key <= '9') pressKey(e.key);
        else if (e.key === 'Backspace') { const el=document.getElementById('answerNum'); el.value=el.value.slice(0,-1); }
        else if (e.key === 'Enter') checkAnswer();
    });

    const charModal = document.getElementById('characterModal');
    const helpModal = document.getElementById('helpModal');
    const hofModal = document.getElementById('hofModal');

    function openCharModal(n) { 
        currentPlayerSelecting = n; 
        const grid = document.getElementById('charGrid');
        grid.innerHTML = '';
        
        for(let i=2; i<=9; i++) {
            const key = `${i}ë‹¨`;
            const div = document.createElement('div');
            div.className = 'char-item';
            div.onclick = () => showCharDetail(key);
            
            const img = document.createElement('img');
            img.src = charData[key].default;
            
            const span = document.createElement('span');
            span.textContent = key;
            
            div.appendChild(img);
            div.appendChild(span);
            grid.appendChild(div);
        }
        
        showGrid();
        charModal.style.display = 'flex'; 
    }
    
    function closeCharModal() { charModal.style.display = 'none'; }
    
    function showGrid() {
        document.getElementById('charModalTitle').textContent = "íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”";
        document.getElementById('charGrid').style.display = 'grid';
        document.getElementById('charDetailView').style.display = 'none';
    }

    function showCharDetail(key) {
        selectedCharKey = key;
        const data = charData[key];
        
        document.getElementById('charModalTitle').textContent = "ì´ ì¹œêµ¬ë‘ í• ê¹Œìš”?";
        document.getElementById('charGrid').style.display = 'none';
        document.getElementById('charDetailView').style.display = 'flex';
        
        document.getElementById('detailImg').src = data.default;
        document.getElementById('detailName').textContent = `${data.name} (${key})`;
        document.getElementById('detailDesc').textContent = data.desc;
    }

    function confirmSelection() {
        const name = selectedCharKey;
        document.getElementById(`player${currentPlayerSelecting}-char`).value = name;
        const charName = charData[name].name;
        document.getElementById(`player${currentPlayerSelecting}-char-name`).textContent = `íŒŒíŠ¸ë„ˆ: ${charName}`;
        closeCharModal();
    }

    function openHelpModal() { helpModal.style.display = 'flex'; }
    function closeHelpModal() { helpModal.style.display = 'none'; }

    // === ì†œì”¨ ìë‘ (ë°ì´í„° ì—°ë™) ê´€ë ¨ ë¡œì§ ===
    async function fetchHallOfFame() {
        const tbody = document.getElementById('hofList');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#5d4037;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... âœ¨</td></tr>';
        
        const restContainer = document.getElementById('hofRestImgContainer');
        const randDan = Math.floor(Math.random()*8) + 2; 
        const restSrc = charData[`${randDan}ë‹¨`].rest;
        restContainer.innerHTML = `<img src="${restSrc}" class="rest-img-deco" alt="íœ´ì‹">`;

        try {
            const res = await fetch(SCRIPT_URL);
            const json = await res.json();
            renderHofTable(json.data);
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#c62828;">ê¸°ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”.</td></tr>';
        }
    }

    // â˜… ì†œì”¨ ìë‘ í…Œì´ë¸”ì— ìºë¦­í„° ì´ë¦„ ë§¤í•‘ ë¡œì§ ì¶”ê°€ â˜…
    function renderHofTable(list) {
        const tbody = document.getElementById('hofList');
        tbody.innerHTML = '';
        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">ì•„ì§ ë“±ë¡ëœ ì†œì”¨ê°€ ì—†ì–´ìš”!</td></tr>';
            return;
        }
        list.forEach((item, index) => {
            let rankDisplay = index + 1;
            if (index === 0) rankDisplay = 'ğŸ¥‡';
            else if (index === 1) rankDisplay = 'ğŸ¥ˆ';
            else if (index === 2) rankDisplay = 'ğŸ¥‰';
            
            // ì €ì¥ëœ '2ë‹¨' ê°™ì€ í‚¤ë¥¼ ì‹¤ì œ ì´ë¦„ 'ë‘ë¦¬'ë¡œ ë³€í™˜
            const charKey = item.character;
            const charName = (charData[charKey]) ? charData[charKey].name : charKey;

            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="hof-rank">${rankDisplay}</td><td>${item.name}</td><td style="color:#c62828; font-weight:bold;">${item.score}</td><td>${charName}</td>`;
            tbody.appendChild(tr);
        });
    }

    function saveScore(name, score, character) {
        if (!name) return;
        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ name, score, character })
        }).catch(console.error);
    }

    function openHofModal() {
        if (!hofModal) return;
        fetchHallOfFame();
        hofModal.style.display = 'flex';
    }
    function closeHofModal() { hofModal.style.display = 'none'; }

    function endGame() {
        document.querySelector('.game-screen').classList.remove('active');
        document.querySelector('.result-screen').classList.add('active');
        
        const sorted = [...players].sort((a,b) => b.score - a.score);
        sorted.forEach(p => {
            if(p.score > 0) saveScore(p.name, p.score, p.character);
        });

        const chart = document.getElementById('final-chart');
        chart.innerHTML = '';
        
        sorted.forEach((p, idx) => {
            let poseSrc = charData[p.character].default;
            if(idx === 0) poseSrc = charData[p.character].win; 
            else if(idx === sorted.length - 1 && sorted.length > 1) poseSrc = charData[p.character].lose;

            const bar = document.createElement('div');
            const height = Math.min(p.score * 5 + 40, 240);
            
            let imgSize = 120;                 
            if (idx === 0) imgSize = 200;      
            else if (idx === 1) imgSize = 170; 
            else if (idx === 2) imgSize = 150; 

            bar.style.cssText = `
                width: ${imgSize}px; height: ${height}px; 
                background: ${idx===0 ? '#fdd835' : '#e0e0e0'};
                border-radius: 10px 10px 0 0;
                text-align: center; position: relative;
                font-weight: bold; padding-top: 10px;
                animation: grow 1s ease-out;
                display:flex; flex-direction:column; justify-content:flex-end; align-items:center;
                min-width: 100px; 
                margin: 0 5px;
            `;
            
            bar.innerHTML = `
                <img src="${poseSrc}" style="width:${imgSize}px; height:${imgSize}px; object-fit:contain; margin-bottom:5px; filter:drop-shadow(0 4px 4px rgba(0,0,0,0.1));">
                <div style="margin-bottom:5px; font-size:${idx===0 ? '1.2em' : '1em'}">${p.score}ì </div>
                <span style="position:absolute; bottom:-30px; left:50%; transform:translateX(-50%); width:120%; color:#333; white-space:nowrap; font-size:0.9em;">${p.name}</span>
            `;
            chart.appendChild(bar);
        });
    }
</script>
</body>
</html>
